
# Question format v3

A **_question_** is really a parameterized question generator that can generate random **_variants_** of itself. One question can have many variants, and a student can make one or more **_submissions_** of an answer to each variant.

A question consists of **_metadata_**, a set of HTML **_templates_**, and (optionally) a set of **_question functions_** in either Python or JavaScript.

All state of question metadata, variants, and submissions is stored in JSON format.

## Question metadata

The metadata of a question describes the question.

Property | Type | Description
--- | --- | ---
`name` | string | A short unique name for the question, not visible by students. This is taken from the directory name of the question files.
`uuid` | UUID | A globally-unique identifier like `b3866207-0a3b-444e-a8c1-355739370152`.
`title` | string | A longer description of the question that is shown to the student.
`thumbnail` | string | A filename containing a thumbnail image for the question.
`topic` | string | The course topic that the question belongs to.
`secondary_topics` | list of strings | Other course topics associated with the question.
`tags` | list of strings | Course tags associated with this question.
`options` | object | Configuration data for this question. Overrides course-level configuration data.

## Question objects

PrairieLearn stores several types of objects in the database to keep track of a particular question variant and the student submitted answers.

Object | Type | Description
--- | --- | ---
`options` | object | Union of the `course.options` and `question.options`, used to control high-level behavior like tolerances for defining a correct answer.
`variant_seed` | integer | A system-generated random value that is used to produce a question `variant`.
`variant` | object | All the information associated with a single parameterized version of a question. This will typically (although not necessarily) have a single correct answer.
`submission` | object | All the information associated with the submisison of an answer by a student, including the grading information if the submission has been graded.

#### `variant` object

Property | Type | Description
--- | --- | ---
`variant.params` | object | The parameters that describe this variant of the question.
`variant.descriptors` | object | Variables that are used to disaggregate question statistics.
`variant.true_answer` | object | The correct answer to this variant.
`variant.complete` | boolean | Whether the student has completely answered this variant (correctly or incorrectly).

#### `submission` object

Property | Type | Description
--- | --- | ---
`submission.submitted_answer` | object | The answer submitted by the student, parsed.
`submission.raw_submitted_answer` | object | The answer submitted by the student, exactly as submitted (not parsed).
`submission.parse_errors` | object | Any errors encountered during parsing.
`submission.scorable` | boolean | Whether the answer was scorable. This is normally `true`, but might be set to `false` if the answer had a format error and couldn't be scored (e.g., a non-numeric value entered for a numeric answer, or a code submission that didn't compile).
`submission.score_perc` | object | The percentage score for the submission (0 to 100).
`submission.feedback` | object | Any feedback that should be shown to the student to explain what was wrong with their answer.

## Question functions

The question functions are called by PrairieLearn to generate and grade question variants.

#### `get_data()` question function

Argument | Intent
--- | ---
`variant_seed` | In
`options` | In
`variant` | Out

Generates a `variant` from a `variant_seed`. The output should be deterministic functions of the inputs, so the randomness of the variant generation comes only from the `variant_seed` that is randomly generated by the main PrairieLearn system. All properties of the `variant` are optional and will be replaced by empty defaults if missing. The `variant.complete` property is ignored and always set to `false` after `get_data()` is called.

#### `grade_answer()` question function

Argument | Intent
--- | ---
`options` | In
`variant` | In/Out
`submisison` | In/Out

Grades the `submisison.submitted_answer` to fill in the `submission.score` and other properties. Can optionally update the `variant` to modify the question before the student makes another submission. By modifying the `variant` a `grade_answer()` function can implement complex student interactions, such as providing interactive hints or allowing a student to submit additional information for partial credit.

## Question templates

The question templates are HTML files with placeholders for randomized parameters. Each template is rendered on the server and then combined into a webpage that is shown to the student.

Name | Guaranteed objects | Optional objects | Required | Purpose
--- | --- | --- | --- | ---
`question.html` | `options`, `params` | `submitted_answer`, `feedback` | Yes | The actual question text presented to the student.
`submission.html` | `options`, `params`, `submitted_answer` | `feedback` | No | The rendering of a student's submitted answer.
`answer.html` | `options`, `params`, `true_answer` | | No | The true answer to the question.

## Subquestions

No support at present for subquestions. This will be added in a future version.

## Basic question flow

To understand how the different parts of a question work together, the flow of a simple single-shot question is given below. We generate the question variant, the student answers it, and then we grade it.

Function | Description
--- | ---
System | Generate a random `variant_seed`.
`get_data()` | Create a variant by generating `params` and `true_answer` from `variant_seed`.
System | Store the `variant` in the database.
`question.html` | Render the variant using `params`.
System | Display the question to the student.
Student | Input answer and click "Submit" button, creating the `submitted_answer`.
`grade_answer()` | Take `params`, `true_answer`, and `submitted_answer` and generate the `score` and `feedback`.
System | Store the `submission` in the database.
`submission.html` | Render the submission using `params`, `submitted_answer`, and `feedback`.
`answer.html` | Render the correct answer using `params` and `true_answer`.
System | Display the submission and answer to the student.


## Full question flow

Depending on the type of assessment (e.g., `Homework` or `Exam`) and the order that a student choosse to navigate and answer questions, the actual flow may be much more complicated than the basic flow shown above. The best way to think about the full system is to break it down into basic operations that can be composed into arbitrary workflows. These basic operations are:

Operation | Description
--- | ---
Create variant | Create a new randomized question variant.
Display question page | Render the question templates to show a student the question variant, all previous submissions, and possibily the true answer.
Save answer | Take a submitted answer from the student and save it to the database.
Grade answer | Grade a saved submitted answer.

The details of these basic operations are given below.

#### “Create variant” operation flow

Function | Description
--- | ---
System | Generate a random `variant_seed`.
`get_data()` | Create a variant by generating `params` and `true_answer` from `variant_seed`.
System | Store the `variant` in the database.

After the variant is created it is normally displayed to the student on the question page.

#### “Display question page” operation flow

Function | Description
--- | ---
`question.html` | Render the variant using `params`.
`submission.html` | If there are submissions, then render each submission using `params`, `submitted_answer`, and `feedback`.
`answer.html` | If `variant.complete` then render the true answer using `params` and `true_answer`.
System | Display the rendered question and possibily submissions and true answer to the student.

Depending on the type of assessment, the number of previous submissions, and the value of `variant.complete`, the question-display page may permit the student to do some of:

1. Save a new `submitted_answer`
2. Grade an existing saved `submitted_answer`
3. Submit and immediately grade a new `submitted_answer` (the equivalent of the two previous operations)
4. Generate a new variant of the question

#### “Save answer” operation flow

Function | Description
--- | ---
Student | Input answer and click "Submit" button, creating the `submitted_answer`.
`grade_answer()` | Take `params`, `true_answer`, and `submitted_answer` and generate the `score` and `feedback`.
System | Store the `submission` in the database.

After a submission is saved to the database the question page would normally be redisplayed to show the updated state with a saved answer.

#### “Grade answer” operation flow

Function | Description
--- | ---
System | Read the `variant` and `submission` out of the database.
`grade_answer()` | Take `params`, `true_answer`, and `submitted_answer` and generate the `score` and `feedback`.
System | Update the `variant` and `submission` in the database.

After a submitted answer has been graded the question page is normally redisplayed to show the score and other information.

## Elements

All element functions have the signature:

```python
def fcn(element_html, element_index, data, options)
```

The arguments are:

Argument | Type | Description
--- | --- | ---
`element_html` | string | The template HTML for the element.
`element_index` | integer | The number of the element in the template.
`data` | dict | Mutable data for the question, which can be modified and returned.
`options` | dict | Immutable data for the question.

The `data` dictionary has the following possible keys (not all keys will be present in all element functions):

Key | Type | Description
--- | --- | ---
`data["params"]` | dict | Parameters that describe the question variant.
`data["true_answer"]` | dict | The true answer (if any) for the variant.
`data["submitted_answer"]` | dict | The answer submitted by the student (after parsing).
`data["parse_errors"]` | dict | Any errors encountered while parsign the student input.
`data["partial_scores"]` | dict | Partial scores for individual variables in the question.
`data["score"]` | float | The total final score for the question.
`data["feedback"]` | dict | Any feedback to the student on their submitted answer.

The `options` dictionary has the following possible keys (not all keys will be present in all element functions):

Key | Type | Description
--- | --- | ---
`options["variant_seed"]` | integer | The random seed for this question variant.
`options["options"]` | dict | Any options associated with the question.
`options["raw_submitted_answer"]` | dict | The answer submitted by the student before parsing.
`options["editable"]` | boolean | Whether the question is currently in an editable state.
`options["panel"]` | string | Which panel is being rendered (`question`, `submisison`, or `answer`).

So that multiple elements can exist together in one question, the convention is that each element instance is associated with one or more **variables**. These variables are keys in the dictionaries for the data elements. For example, if there are variables `x` and `y` then we might have:

```
true_answer["params"]["x"] = 4
true_answer["params"]["y"] = 7
```

This structure, where dictionaries have variables as keys, is used all dictionaries in `data` and for `options["raw_submitted_answer"]`.

The element functions are:

Function | Return object | modifiable `data` keys | unmodifiable `data` keys | Description
--- | --- | --- | --- | ---
`generate()` | `data` (dict) | `params`, `true_answer` | `variant_seed`, `options` | Generate the parameter and true answers for a new random question variant. Set `data["params"][name]` and `data["true_answer"][name]` for any variables as needed. Return the modified `data` dictionary.
`prepare()` | `data` (dict) | `params`, `true_answer` | `variant_seed`, `options` | Final question preparation after element code has run. Can modify data as necessary. Return the modified `data` dictionary.
`render()` | `html` (string) | `params`, `true_answer`, `submitted_answer`, `parse_errors`, `partial_scores`, `score`, `feedback` `variant_seed`, `options`, `raw_submitted_answer`, `editable`, `panel` | Render the HTML for one panel and return it as a string.
`parse()` | `data` (dict) | `submitted_answer`, `parse_errors` | `params`, `true_answer`, `variant_seed`, `options`, `raw_submitted_answer` | Parse the `data["submitted_answer"][var]` data entered by the student, modifying this variable. Return the modified `data` dictionary.
`grade()` | `data` (dict) | `params`, `true_answer`, `submitted_answer`, `parse_errors`, `partial_scores`, `score`, `feedback` | `variant_seed`, `options`, `raw_submitted_answer` | Grade `data["submitted_answer"][var]` to determine a score. Store the score and any feedback in `data["partial_scores"][var]["score"]` and `data["partial_scores"][var]["feedback"]`. Return the modified `data` dictionary.

The above function descriptions describe the typical variables that will be read and modified by each function. However, any function that returns `data` (i.e., not `parse()`) is allowed to modify any of the values in `data` and these changes will be persisted to the database. No function is allowed to add new keys to `data`.

## Built-in Elements

### `multiple_choice` element

```html
<multiple_choice name="acc" weight="1" inline="true">
  <answer correct="false">positive</answer>
  <answer correct="true">negative</answer>
  <answer correct="false">zero</answer>
</multiple_choice>
```

Attribute | Type | Default | Description
--- | --- | --- | ---
`name` | string | — | Variable name to store data in.
`weight` | integer | 1 | Weight to use when computing a weighted average score over elements.
`inline` | boolean | false | List answer choices on a single line instead of as separate paragraphs.
`number_answers` | integer | special | The total number of answer choices to display. Defaults to displaying one correct answer and all incorrect answers.
`fixed_order` | boolean | false | Disable the randomization of answer order.

A `multiple_choice` element selects one correct answer and zero or more incorrect answers and displays them in a random order as radio buttons.

An `answer` element inside a `multiple_choice` element has attributes:

Attribute | Type | Default | Description
--- | --- | --- | ---
`correct` | boolean | false | Is this a correct answer to the question?

### `checkbox` element

```html
<checkbox name="vpos" weight="1" inline="true">
  <answer correct="true">A-B</answer>
  <answer correct="true">B-C</answer>
  <answer>               C-D</answer>
  <answer correct="true">D-E</answer>
  <answer>               E-F</answer>
  <answer>               F-G</answer>
</checkbox>
```

Attribute | Type | Default | Description
--- | --- | --- | ---
`name` | string | — | Variable name to store data in.
`weight` | integer | 1 | Weight to use when computing a weighted average score over elements.
`inline` | boolean | false | List answer choices on a single line instead of as separate paragraphs.
`number_answers` | integer | special | The total number of answer choices to display. Defaults to displaying all answers.
`min_correct` | integer | special | The minimum number of correct answers to display. Defaults to displaying all correct answers.
`max_correct` | integer | special | The maximum number of correct answers to display. Defaults to displaying all correct answers.
`fixed_order` | boolean | false | Disable the randomization of answer order.

A `multiple_choice` element displays a subset of the answers in a random order as checkboxes.

An `answer` element inside a `multiple_choice` element has attributes:

Attribute | Type | Default | Description
--- | --- | --- | ---
`correct` | boolean | false | Is this a correct answer to the question?

### `number_input` element

```html
<number_input name="v_avg" true_answer="0.8" sig_figs="2"/>
```

Attribute | Type | Default | Description
--- | --- | --- | ---
`name` | string | — | Variable name to store data in.
`weight` | integer | 1 | Weight to use when computing a weighted average score over elements.
`true_answer` | float | special | True answer for grading. Defaults to `true_answer[name]`.
`sig_figs` | integer | 3 | Number of significant figures to use for grading.

### `question_panel` element

Only display contents when rendering the question panel.

### `variable_score` element

Display the partial score for a specific variable.
