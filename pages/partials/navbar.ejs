<nav class="navbar navbar-dark bg-dark navbar-expand-md mb-4">
  <a class="navbar-brand" href="<%= homeUrl %>">
    <span class="navbar-brand-label">PrairieLearn</span>
    <span class="navbar-brand-hover-label text-secondary">Go home <i class="fa fa-angle-right" aria-hidden="true"></i></span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse">
    <ul class="nav navbar-nav mr-auto" id="main-nav">
      <% if (typeof navbarType == 'undefined' || navbarType == 'plain') { %>
        <%- include('navbarPlain'); %>
      <% } else if (navbarType == 'student') { %>
        <%- include('navbarStudent'); %>
      <% } else if (navbarType == 'instructor') { %>
        <%- include('navbarInstructor'); %>
      <% } else { %>
        <% throw new Error('Unknown navbarType: ' + navbarType); %>
      <% } %>
    </ul>

    <!-------------------------------------------------------------------------------->
    <!-------------------------------------------------------------------------------->
    <!-------------------------------------------------------------------------------->
    <!-- User and logout ------------------------------------------------------------->

    <%
    let displayedName;
    if (locals.authz_data) {
      if (locals.authz_data.user.name) {
        displayedName = authz_data.user.name;
      } else {
        displayedName = authz_data.user.uid;
      }

      if (authz_data.mode != 'Public') {
        displayedName += ' (' + authz_data.mode + ')';
      }
    } else if (locals.authn_user) {
      displayedName = authn_user.name;
    } else {
      displayName = '(no user)';
    }
    %>

    <ul class="nav navbar-nav" id="username-nav">
      <% if (devMode) { %>
          <li class="mb-2 mb-md-0 mr-2 "><a class="btn btn-success" href="<%= urlPrefix %>/loadFromDisk">Load from disk</a></li>
      <% } %>


      <li class="nav-item dropdown mb-2 mb-md-0 mr-2 <% if (navPage == "effective") { %>active<% } %>">
        <a class="nav-link dropdown-toggle <% if (locals.authz_data && authz_data.overrides) { %>text-warning<% } %>" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <%= displayedName %>
          <% if (typeof news_item_notification_count != 'undefined' && news_item_notification_count > 0) { %>
            <span class="badge badge-pill badge-primary news-item-count"><%= news_item_notification_count %></span>
          <% } %>
        </a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">

          <% if (locals.authz_data &&
                 (authz_data.authn_has_course_permission_preview || authz_data.authn_has_course_instance_permission_view) &&
                 locals.course_instance &&
                 locals.viewType &&
                 ((navbarType == 'student') || (navbarType == 'instructor'))) {

            // Checking that navbarType is either 'student' or 'instructor' is equivalent
            // to checking that authzCourseOrInstance threw no error.
            //
            // One might want to show the "View type" section of this dropdown menu even
            // if authzCourseOrInstance threw an error. However, in this case, urlPrefix
            // would not be consistent with the course instance and so you would need to
            // be careful to construct all full URLs by hand.

            const student_access_cookie_path = `${plainUrlPrefix}/course_instance/${course_instance.id}`;
          %>

            <h6 class="dropdown-header">View type</h6>

            <% if (authz_data.overrides) { %>

              <% if (viewType == 'instructor') {

                var studentLink = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessments`;
                if (locals.assessment && assessment.id) {
                    studentLink = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessment/${assessment.id}`;
                }

              %>

                <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;; window.location.reload()">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0">&#10003;</div>
                    <div class="col pl-0">Instructor</div>
                  </div>
                </button>

                <a class="dropdown-item" href="<%= studentLink %>" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;;">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0"></div>
                    <div class="col pl-0">Student</div>
                  </div>
                </a>

              <% } else if (viewType == 'student') {

                var instructorLink = `${urlPrefix}/instructor/instance_admin`;
                if (locals.question && question.id) {
                    instructorLink = `${urlPrefix}/instructor/question/${question.id}`;
                } else if (locals.assessment_instance && assessment_instance.assessment_id) {
                    instructorLink = `${urlPrefix}/instructor/assessment/${assessment_instance.assessment_id}`;
                }

              %>

                <a class="dropdown-item" href="<%= instructorLink %>" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;;">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0"></div>
                    <div class="col pl-0">Instructor</div>
                  </div>
                </a>

                <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;; window.location.reload()">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0">&#10003;</div>
                    <div class="col pl-0">Student</div>
                  </div>
                </button>

              <% } %>

            <% } else { %>

              <% if (viewType == 'instructor') {

                var studentLink = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessments`;
                if (locals.assessment && assessment.id) {
                    studentLink = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessment/${assessment.id}`;
                }

              %>

              <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;; window.location.reload()">
                <div class="d-flex flex-row justify-content-left">
                  <div class="col-1 px-0">&#10003;</div>
                  <div class="col pl-0">Instructor</div>
                </div>
              </button>

              <a class="dropdown-item" href="<%= studentLink %>" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;;">
                <div class="d-flex flex-row justify-content-left">
                  <div class="col-1 px-0"></div>
                  <div class="col pl-0">Student (with instructor access)</div>
                </div>
              </a>

              <a class="dropdown-item" href="<%= studentLink %>" onClick="document.cookie=&quot;pl_access_as_student=active;max-age=3600000;path='<%= student_access_cookie_path %>'&quot;;">
                <div class="d-flex flex-row justify-content-left">
                  <div class="col-1 px-0"></div>
                  <div class="col pl-0">Student</div>
                </div>
              </a>


              <% } else if (viewType == 'student') {

                var instructorLink = `${urlPrefix}/instructor/instance_admin`;
                if (locals.question && question.id) {
                    instructorLink = `${urlPrefix}/instructor/question/${question.id}`;
                } else if (locals.assessment_instance && assessment_instance.assessment_id) {
                    instructorLink = `${urlPrefix}/instructor/assessment/${assessment_instance.assessment_id}`;
                }

              %>

                <a class="dropdown-item" href="<%= instructorLink %>" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;;">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0"></div>
                    <div class="col pl-0">Instructor</div>
                  </div>
                </a>

                <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_access_as_student=;max-age=0;path='<%= student_access_cookie_path %>'&quot;; window.location.reload()">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0"><% if (!authz_data.student_view_with_student_access) { %>&#10003;<% } %></div>
                    <div class="col pl-0">Student (with instructor access)</div>
                  </div>
                </button>

                <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_access_as_student=active;max-age=3600000;path='<%= student_access_cookie_path %>'&quot;; window.location.reload()">
                  <div class="d-flex flex-row justify-content-left">
                    <div class="col-1 px-0"><% if (authz_data.student_view_with_student_access) { %>&#10003;<% } %></div>
                    <div class="col pl-0">Student</div>
                  </div>
                </button>

              <% } %>

            <% } %>

            <div class="dropdown-divider"></div>

          <% } %>

          <% if ((locals.authn_is_administrator) || (locals.authz_data && authz_data.authn_has_course_permission_edit)) { %>

            <h6 class="dropdown-header">Access control</h6>

            <% if (locals.authn_is_administrator) { %>

              <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_access_as_administrator=<% if (!locals.access_as_administrator) { %>active;max-age=3600000<% } else { %>;max-age=0<% } %>;path='/'&quot;; window.location.reload()">
                <div class="d-flex flex-row justify-content-left">
                  <div class="col-1 px-0"></div>
                  <div class="col pl-0"><% if (locals.access_as_administrator) { %>Turn off administrator access<% } else { %>Turn on administrator access<% }%></div>
                </div>
              </button>

            <% } %>

            <% if (locals.authz_data && authz_data.authn_has_course_permission_edit) {

              let effectiveUserUrl = `${urlPrefix}/effectiveUser`;
              if (navbarType != 'student' && navbarType != 'instructor') {
                // The only way for auhz_data to exist, for authn_has_course_permission_preview to be true,
                // and for navbarType to be neither student nor instructor, is if we are in a course or course
                // instance and if the effective user does not have access.
                //
                // In this case, we still want a link to the "Change effective user" page, but we need to
                // construct this link from scratch, because urlPrefix corresponds neither to the student
                // page route nor the instructor page route (it gets set after successful authorization).
                //
                // It is ok to use the instructor route only to the effectiveUser page - this will redirect
                // to the student route if necessary.
                if (locals.course_instance) {
                  effectiveUserUrl = `${plainUrlPrefix}/course_instance/${course_instance.id}/instructor/effectiveUser`;
                } else {
                  effectiveUserUrl = `${plainUrlPrefix}/course/${course.id}/effectiveUser`;
                }
              }
            %>

              <a class="dropdown-item <% if (authz_data.student_view_with_student_access) { %>disabled<% } %>" href="<%= effectiveUserUrl %>">
                <div class="d-flex flex-row justify-content-left">
                  <div class="col-1 px-0"></div>
                  <div class="pl-0">Change effective user</div>
                </div>
              </a>

              <% if (authz_data.overrides) { %>
                <div class="list-group small dropdown-item-text px-4" style="white-space: nowrap">
                  <% authz_data.overrides.forEach(function(override) { %>
                    <%- include('navbarUserDropdownOverrideItem', {override: override}); %>
                  <% }); %>
                </div>
              <% } %>

              <div class="dropdown-divider"></div>

            <% } %>

          <% } %>

          <a class="dropdown-item" href="<%= plainUrlPrefix %>/settings">Settings</a>
          <a class="dropdown-item news-item-link" href="<%= urlPrefix %>/news_items">
            News
            <% if (typeof news_item_notification_count != 'undefined' && news_item_notification_count > 0) { %>
              <span class="badge badge-pill badge-primary news-item-link-count"><%= news_item_notification_count %></span>
            <% } %>
          </a>

          <%- include('logout'); %>

        </div>
      </li>
    </ul>
  </div>
</nav>
