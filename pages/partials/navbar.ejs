<nav class="navbar navbar-dark bg-dark navbar-expand-md mb-4">
  <a class="navbar-brand" href="<%= homeUrl %>">
    <span class="navbar-brand-label">PrairieLearn</span>
    <span class="navbar-brand-hover-label text-secondary">Go home <i class="fa fa-angle-right" aria-hidden="true"></i></span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target=".navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse">
    <ul class="nav navbar-nav mr-auto" id="main-nav">
        <% if (typeof navbarType == 'undefined' || navbarType == 'plain') { %>
        <%- include('navbarPlain'); %>
        <% } else if (navbarType == 'student') { %>
        <%- include('navbarStudent'); %>
        <% } else if (navbarType == 'instructor') { %>
        <%- include('navbarInstructor'); %>
        <% } else { %>
        <% throw new Error('Unknown navbarType: ' + navbarType); %>
        <% } %>
    </ul>

    <!-------------------------------------------------------------------------------->
    <!-------------------------------------------------------------------------------->
    <!-------------------------------------------------------------------------------->
    <!-- User and logout ------------------------------------------------------------->

<%
let displayedName;
if (locals.authz_data) {
  if (locals.authz_data.user.name) {
    displayedName = authz_data.user.name;
  } else {
    displayedName = authz_data.user.uid;
  }

  if (authz_data.mode != 'Public') {
    displayedName += ' (' + authz_data.mode + ')';
  }
} else if (locals.authn_user) {
  displayedName = authn_user.name;
} else {
  displayName = '(no user)';
}
%>

<ul class="nav navbar-nav" id="username-nav">
  <% if (devMode) { %>
      <li class="mb-2 mb-md-0 mr-2 "><a class="btn btn-success" href="<%= urlPrefix %>/loadFromDisk">Load from disk</a></li>
  <% } %>


    <li class="nav-item dropdown mb-2 mb-md-0 mr-2 <% if (navPage == "effective") { %>active<% } %>">
        <a class="nav-link dropdown-toggle <% if (locals.authz_data && authz_data.overrides) { %>text-warning<% } %>" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <%= displayedName %>
            <% if (typeof news_item_notification_count != 'undefined' && news_item_notification_count > 0) { %>
              <span class="badge badge-pill badge-primary news-item-count"><%= news_item_notification_count %></span>
            <% } %>
        </a>
        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">

            <% if (locals.authz_data && authz_data.authn_has_course_permission_preview) { %>
            <a class="dropdown-item" href="<%= urlPrefix %>/effectiveUser">Change effective user</a>

            <% if (authz_data.overrides) { %>
            <div class="list-group small dropdown-item-text px-4" style="white-space: nowrap">
              <% authz_data.overrides.forEach(function(override) { %>
                <%- include('navbarUserDropdownOverrideItem', {override: override}); %>
              <% }); %>
            </div>
            <% } %>

            <div class="dropdown-divider"></div>
            <% } %>

            <% if (locals.is_instructor) { %>
            <h6 class="dropdown-header">User type</h6>

            <%
            let check_administrator = false;
            let check_instructor = false;
            let check_student = false;

            if (locals.max_access_level) {
              if (max_access_level == 'Instructor') {
                check_instructor = true;
              } else if (max_access_level == 'Student') {
                check_student = true;
              } else {
                // do nothing (should never get here)
              }
            } else {
              if (is_administrator) {
                check_administrator = true;
              } else {
                check_instructor = true;
              }
            }
            %>

            <% if (locals.is_administrator) { %>

            <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_requested_max_access_level=Administrator;max-age=3600000;path='/'&quot;; window.location.reload()">
              <div class="row">
                <div class="col-1"><% if (check_administrator) { %>&#10003;<% } %></div>
                <div class="col">Administrator</div>
              </div>
            </button>

            <% } %>

            <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_requested_max_access_level=Instructor;max-age=3600000;path='/'&quot;; window.location.reload()">
              <div class="row">
                <div class="col-1"><% if (check_instructor) { %>&#10003;<% } %></div>
                <div class="col">Instructor</div>
              </div>
            </button>
            <button class="dropdown-item" type="button" onClick="document.cookie=&quot;pl_requested_max_access_level=Student;max-age=3600000;path='/'&quot;; window.location.reload()">
              <div class="row">
                <div class="col-1"><% if (check_student) { %>&#10003;<% } %></div>
                <div class="col">Student</div>
              </div>
            </button>

            <% if (locals.course_instance) { %>

            <div class="dropdown-divider"></div>
            <h6 class="dropdown-header">View type</h6>

            <% if (navbarType == 'instructor') {

              var studentLink = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessments`;
              if (locals.assessment && assessment.id) {
                  studentLink = `${plainUrlPrefix}/course_instance/${course_instance.id}/assessment/${assessment.id}`;
              }

            %>

              <button class="dropdown-item" type="button" onClick="window.location.reload()">
                <div class="row">
                  <div class="col-1">&#10003;</div>
                  <div class="col">Instructor</div>
                </div>
              </button>

              <a class="dropdown-item" href="<%= studentLink %>">
                <div class="row">
                  <div class="col-1"></div>
                  <div class="col">Student</div>
                </div>
              </a>

            <% } else {

              var instructorLink = `${urlPrefix}/instructor/instance_admin`;
              // If we know its question or assessment id, link right to it.
              if (locals.question && question.id) {
                  instructorLink = `${urlPrefix}/instructor/question/${question.id}`;
              } else if (locals.assessment_instance && assessment_instance.assessment_id) {
                  instructorLink = `${urlPrefix}/instructor/assessment/${assessment_instance.assessment_id}`;
              }

            %>

              <a class="dropdown-item" href="<%= instructorLink %>">
                <div class="row">
                  <div class="col-1"></div>
                  <div class="col">Instructor</div>
                </div>
              </a>

              <button class="dropdown-item" type="button" onClick="window.location.reload()">
                <div class="row">
                  <div class="col-1">&#10003;</div>
                  <div class="col">Student</div>
                </div>
              </button>

            <% } %>

            <% } %>

            <% } %>

            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="<%= plainUrlPrefix %>/settings">Settings</a>
            <a class="dropdown-item news-item-link" href="<%= urlPrefix %>/news_items">
              News
              <% if (typeof news_item_notification_count != 'undefined' && news_item_notification_count > 0) { %>
                <span class="badge badge-pill badge-primary news-item-link-count"><%= news_item_notification_count %></span>
              <% } %>
            </a>
            <%- include('logout'); %>

        </div>
    </li>

</ul>
</div>
</nav>
